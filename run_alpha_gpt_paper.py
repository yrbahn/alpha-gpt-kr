#!/usr/bin/env python3
"""
Alpha-GPT ë…¼ë¬¸ ë°©ì‹ ì‹¤í–‰
LLMì„ ì‚¬ìš©í•œ ì•ŒíŒŒ ë§ˆì´ë‹ (ì‹œê°€ì´ì•¡ ìƒìœ„ 500ê°œ ì¢…ëª©)
"""

import sys
import os
from pathlib import Path
from datetime import date
import pandas as pd
from dotenv import load_dotenv
import psycopg2
from psycopg2.extras import execute_values

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì¶”ê°€
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

from alpha_gpt_kr.core import AlphaGPT

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

def get_db_connection():
    """PostgreSQL ì—°ê²°"""
    return psycopg2.connect(
        host=os.getenv('DB_HOST', '192.168.0.248'),
        port=int(os.getenv('DB_PORT', 5432)),
        database=os.getenv('DB_NAME', 'marketsense'),
        user=os.getenv('DB_USER', 'yrbahn'),
        password=os.getenv('DB_PASSWORD', '1234')
    )

def get_top_500_tickers():
    """ì‹œê°€ì´ì•¡ ìƒìœ„ 500ê°œ ì¢…ëª© í‹°ì»¤ ê°€ì ¸ì˜¤ê¸°"""
    conn = get_db_connection()
    
    query = """
        SELECT DISTINCT ON (s.ticker)
            s.ticker
        FROM stocks s
        JOIN price_data p ON s.id = p.stock_id
        WHERE s.is_active = true
        AND p.date = (SELECT MAX(date) FROM price_data)
        AND p.close IS NOT NULL
        AND p.volume IS NOT NULL
        ORDER BY s.ticker, (p.close * p.volume) DESC
        LIMIT 500
    """
    
    df = pd.read_sql(query, conn)
    conn.close()
    
    return df['ticker'].tolist()

def save_alpha_to_db(alpha_expr, backtest_result, calc_date=None):
    """ìµœìƒìœ„ ì•ŒíŒŒë¥¼ DBì— ì €ì¥"""
    if calc_date is None:
        calc_date = date.today()
    
    conn = get_db_connection()
    cur = conn.cursor()
    
    try:
        # alpha_performance í…Œì´ë¸”ì— ì €ì¥
        cur.execute("""
            INSERT INTO alpha_performance
            (alpha_formula, start_date, is_active, total_return, sharpe_ratio, 
             max_drawdown, notes)
            VALUES (%s, %s, %s, %s, %s, %s, %s)
            ON CONFLICT (alpha_formula, start_date) DO UPDATE SET
                total_return = EXCLUDED.total_return,
                sharpe_ratio = EXCLUDED.sharpe_ratio,
                max_drawdown = EXCLUDED.max_drawdown,
                notes = EXCLUDED.notes
        """, (
            alpha_expr,
            calc_date,
            True,
            backtest_result.annual_return,
            backtest_result.sharpe_ratio,
            backtest_result.max_drawdown,
            f"IC: {backtest_result.ic:.4f}, Generated by Alpha-GPT"
        ))
        
        conn.commit()
        print(f"âœ… ì•ŒíŒŒ ì„±ê³¼ DB ì €ì¥ ì™„ë£Œ")
        
    finally:
        cur.close()
        conn.close()

def main():
    print("=" * 70)
    print("Alpha-GPT: ë…¼ë¬¸ ë°©ì‹ ì•ŒíŒŒ ë§ˆì´ë‹")
    print("=" * 70)
    print("LLMì„ ì‚¬ìš©í•œ ìë™ ì•ŒíŒŒ ìƒì„± ë° ìµœì í™”")
    print("=" * 70)
    print()
    
    try:
        # 1. AlphaGPT ì´ˆê¸°í™”
        print("ğŸ“Š 1ë‹¨ê³„: AlphaGPT ì´ˆê¸°í™”")
        
        # LLM ì„ íƒ (OpenAI ì‚¬ìš©)
        alpha_gpt = AlphaGPT(
            market="KRX",
            llm_provider="openai",
            model="gpt-4-turbo-preview"  # ë˜ëŠ” "gpt-4"
        )
        print("âœ… AlphaGPT ì´ˆê¸°í™” ì™„ë£Œ (OpenAI GPT-4)")
        
        # 2. ë°ì´í„° ë¡œë“œ
        print("\nğŸ“Š 2ë‹¨ê³„: ì‹œê°€ì´ì•¡ ìƒìœ„ 500ê°œ ì¢…ëª© ë°ì´í„° ë¡œë“œ")
        
        top_500 = get_top_500_tickers()
        print(f"âœ… ìƒìœ„ 500ê°œ ì¢…ëª© ì„ íƒ")
        
        # ìµœê·¼ 1ë…„ ë°ì´í„° (ë°±í…ŒìŠ¤íŠ¸ìš©)
        alpha_gpt.load_data(
            universe=top_500,
            start_date="2024-02-01",
            end_date="2026-02-12",
            include_technical=False
        )
        print("âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ (2024-02-01 ~ 2026-02-12)")
        
        # 3. íŠ¸ë ˆì´ë”© ì•„ì´ë””ì–´ ì •ì˜
        print("\nğŸ“Š 3ë‹¨ê³„: íŠ¸ë ˆì´ë”© ì•„ì´ë””ì–´")
        
        trading_idea = """
        í•œêµ­ ì¦ì‹œì—ì„œ ê°•í•œ ëª¨ë©˜í…€ì„ ë³´ì´ëŠ” ì¢…ëª©ì„ ì°¾ê³  ì‹¶ìŠµë‹ˆë‹¤.
        
        ì „ëµ ì»¨ì…‰:
        1. ì¤‘ê¸° ëª¨ë©˜í…€ (20-30ì¼)ì´ ê°•í•œ ì¢…ëª©
        2. ë‹¨ê¸° ë³€ë™ì„± ëŒ€ë¹„ ìˆ˜ìµë¥ ì´ ì¢‹ì€ ì¢…ëª©
        3. ê±°ë˜ëŸ‰ì´ í‰ê·  ì´ìƒìœ¼ë¡œ í™œë°œí•œ ì¢…ëª©
        
        ëª©í‘œ:
        - ìƒ¤í”„ ë¹„ìœ¨ 1.0 ì´ìƒ
        - IC (Information Coefficient) 0.01 ì´ìƒ
        - ìµœëŒ€ ë‚™í­ -30% ì´ë‚´
        
        ì‚¬ìš© ê°€ëŠ¥í•œ ë°ì´í„°:
        - close: ì¢…ê°€
        - open: ì‹œê°€
        - high: ê³ ê°€
        - low: ì €ê°€
        - volume: ê±°ë˜ëŸ‰
        - vwap: ê±°ë˜ëŸ‰ ê°€ì¤‘ í‰ê·  ê°€ê²©
        
        ì‹œê°„ í”„ë ˆì„: 20-50ì¼
        """
        
        print("âœ… ì•„ì´ë””ì–´:")
        print("   - ì¤‘ê¸° ëª¨ë©˜í…€ + ë‚®ì€ ë³€ë™ì„± + ê±°ë˜ëŸ‰")
        print("   - ëª©í‘œ: Sharpe 1.0+, IC 0.01+")
        
        # 4. ì•ŒíŒŒ ë§ˆì´ë‹ ì‹¤í–‰
        print("\nğŸ“Š 4ë‹¨ê³„: ì•ŒíŒŒ ë§ˆì´ë‹ (LLM + GP)")
        print("   â±ï¸  ì˜ˆìƒ ì†Œìš” ì‹œê°„: 10-30ë¶„")
        print("   (LLM API í˜¸ì¶œ + ë°±í…ŒìŠ¤íŠ¸ ë°˜ë³µ)")
        print()
        
        result = alpha_gpt.mine_alpha(
            idea=trading_idea,
            num_seeds=10,          # LLMì´ ìƒì„±í•  ì´ˆê¸° ì•ŒíŒŒ ê°œìˆ˜
            enhancement_rounds=20,  # GP ì§„í™” ì„¸ëŒ€ ìˆ˜
            mode="autonomous",      # ìë™ ëª¨ë“œ
            top_n=5                # ìƒìœ„ 5ê°œ ë°˜í™˜
        )
        
        # 5. ê²°ê³¼ ì¶œë ¥
        print("\n" + "=" * 70)
        print("âœ… ì•ŒíŒŒ ë§ˆì´ë‹ ì™„ë£Œ!")
        print("=" * 70)
        
        print(f"\nğŸ† ìµœìƒìœ„ ì•ŒíŒŒ:")
        print(f"   ê³µì‹: {result.top_alphas[0][0]}")
        print(f"   IC: {result.best_ic:.4f}")
        print(f"   Sharpe: {result.best_sharpe:.2f}")
        
        print(f"\nğŸ“Š ìƒìœ„ 5ê°œ ì•ŒíŒŒ:")
        for i, (expr, br) in enumerate(result.top_alphas, 1):
            print(f"\n   {i}. {expr[:80]}...")
            print(f"      IC: {br.ic:.4f} | Sharpe: {br.sharpe_ratio:.2f} | "
                  f"Return: {br.annual_return:.2%} | MDD: {br.max_drawdown:.2%}")
        
        print(f"\nğŸ“ ë¶„ì„ ë¦¬í¬íŠ¸:")
        print(result.analysis_report)
        
        # 6. DB ì €ì¥
        print("\nğŸ“Š 5ë‹¨ê³„: ìµœìƒìœ„ ì•ŒíŒŒ DB ì €ì¥")
        
        best_expr = result.top_alphas[0][0]
        best_result = result.top_alphas[0][1]
        
        save_alpha_to_db(best_expr, best_result)
        
        print("\n" + "=" * 70)
        print("ğŸ‰ Alpha-GPT ë…¼ë¬¸ ë°©ì‹ ì‹¤í–‰ ì™„ë£Œ!")
        print("=" * 70)
        print(f"\në‹¤ìŒ ë‹¨ê³„:")
        print(f"1. ìƒì„±ëœ ì•ŒíŒŒë¥¼ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±ì— ì‚¬ìš©")
        print(f"2. ì‹¤ì „ ë§¤ë§¤ ì „ ì¶”ê°€ ë°±í…ŒìŠ¤íŠ¸ ê¶Œì¥")
        print(f"3. ëŒ€ì‹œë³´ë“œì—ì„œ ì„±ê³¼ ëª¨ë‹ˆí„°ë§")
        
    except Exception as e:
        print(f"\nâŒ Error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    main()
